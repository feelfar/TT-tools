# 水印区域兼容性功能

## 概述

TT img enc/dec 节点现在支持自动避开水印区域，确保即使图片被平台添加水印，数据也能正确提取。

## 功能特性

### 自动水印区域预留
- **预留区域**: 图片左上角50像素高度区域
- **数据写入**: 从第51行开始写入数据
- **兼容性**: 确保平台添加的水印不会影响数据完整性

### 编码节点 (tt_img_enc_node.py)
- 自动计算所需图片尺寸，考虑水印区域
- 数据从第51行开始嵌入，前50行保持原样
- 容量计算已优化，确保有足够空间存储数据

### 解码节点 (tt_img_dec_node.py)
- 从第51行开始读取数据，跳过水印区域
- 自动处理带水印的图片
- 确保数据提取的准确性

### 独立解码工具 (extract_zip.py)
- 从第51行开始读取数据，跳过水印区域
- 支持命令行使用，无需ComfyUI环境
- 自动处理带水印的图片

## 技术实现

### 水印区域处理
```python
watermark_height = 50  # 水印区域高度
# 编码：从第51行开始写入数据
for i in range(watermark_height, image.shape[0]):
    # 数据嵌入逻辑

# 解码：从第51行开始读取数据
for i in range(watermark_height, height):
    # 数据提取逻辑
```

### 容量计算优化
- 考虑水印区域占用空间
- 确保可用像素足够存储数据
- 自动调整图片尺寸以满足需求

## 使用说明

### 编码
1. 正常使用编码节点
2. 系统会自动预留水印区域
3. 输出图片左上角50像素区域可用于平台水印

### 解码
1. 直接使用解码节点处理图片
2. 无论是否添加水印都能正确提取数据
3. 系统自动跳过水印区域

### 独立解码工具
```bash
python extract_zip.py <图片路径> [输出路径]
```
- 支持命令行使用
- 自动跳过水印区域
- 无需ComfyUI环境

## 测试验证

功能已通过以下测试：
- ✅ 基本编码解码测试
- ✅ 水印区域保持未修改
- ✅ 模拟水印添加测试
- ✅ 带水印图片数据提取测试
- ✅ extract_zip.py 独立解码测试

## 注意事项

1. **图片尺寸**: 由于需要预留水印区域，生成的图片尺寸可能比之前稍大
2. **存储效率**: 水印区域不参与数据存储，但整体存储效率仍然很高
3. **兼容性**: 向后兼容，旧版本生成的图片仍可正常解码
4. **平台支持**: 适用于所有会在图片左上角添加水印的平台

## 更新日志

- **v2.0**: 添加水印区域兼容性功能
- 自动预留50像素高度水印区域
- 优化容量计算算法
- 增强解码节点兼容性
- 更新 extract_zip.py 支持水印区域
